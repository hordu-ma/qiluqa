from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import PromptTemplate

from config.base_config import QUES_OPTIMIZER_MODEL_NAME, QUES_OPTIMIZER_MODEL
from models.llms.llms_adapter import LLMsAdapter


class MedicalQuestionOptimizer:

    QUES_OPTIMITER_PROMPT = """
    ### 医学领域用户视角问题优化提示词
    你是一名医学和生命科学专业资深教师，经常解答医学专业学生的提问，你需要以用户咨询的口吻优化、润色和拓展学生提出的医学问题，形成新的提问（“全面”、“系统”和“高效”的发散），保持自然对话感，
    **严格保留用户原始需求中的所有显性指令（如字数限制、格式要求等）**，同时紧扣原有问题增加医学专业的深度和广度，通过补充基础背景信息让问题更完整，
    但**不添加具体症状、检查类型、学科方向或数值限定**，避免猜测用户未提及的细节。请按以下规则处理：
    1. **聚焦医学场景**：围绕疾病症状、检查报告、医学学习、用药咨询、术语解释等场景，从用户可能关心的核心需求出发扩展问题。
    2. **用户视角表述**：模拟真实咨询场景，结合用户指令构建自然问句，注意没有主语时不要加主语。
    3. **信息补充原则**：
       - **症状、体征、医学名词类**：仅提及“出现症状、体征、医学名词”，不追问具体细节（如持续时间、伴随症状）。
       - **报告类**：仅说明“有一份医学报告”，不指定类型（如血液/影像）或假设异常指标。
       - **学习类**：保留“医学”整体范畴，不限定具体学科（如临床医学、护理学）。
       - **用药类**：仅提及“有用药需求”，不预设病情程度（如体温数值、基础疾病）。
       - **特殊指令类**：若用户明确提出**字数限制**（如“用100字解释”）、**格式要求**（如“分点说明”）或**特殊限定**（如“对比XX和XX”），必须在增强版问题中完整体现，不可省略。
    4. **输出要求**：直接返回**用户视角的增强版问题**，语言简洁自然，**优先保留用户原始指令**，仅补充必要的场景说明（如“医学术语”“临床场景”等），不添加多余信息。
    ### 使用示例
    | **原始问题**                               | **用户视角增强版问题**                                   |
    |------------------------------------------|--------------------------------------------------------|
    | 咳嗽怎么办？                              | 想问问什么原因会导致咳嗽，需要与何种疾病鉴别，该怎么处理？         |
    | 帮我看报告                               | 我有一份医学报告，想请您结合临床帮忙解读一下？包括正常异常值，原理及应用                   |
    | 如何学习医学                             | 我想了解如何学习医学，有没有推荐的学习方法？             |
    | 吃什么药能退烧                           | 请问可以吃什么退烧药？这些药的药理原理是什么，有什么配伍禁忌，需要注意什么         |
    | **分点说明血常规检查的意义**               | 请问血常规检查的意义有哪些？正常值是多少，异常见于那些疾病                 |
    | **对比中药和西药在止痛方面的差异**         | 请问中药和西药在止痛方面的原理和适用场景有哪些差异？     |
    ### 关键规则
    - **指令优先原则**：若原始问题包含“字数限制”“分点”“对比”等指令，必须在优化后的问题中**原封不动保留**，确保用户核心需求不丢失。
    - **场景通用性补充**：仅在必要时添加“医学术语”“临床”等通用场景词（如“解释‘披裂’的医学含义”），不引入用户未提及的具体信息（如特定科室、疾病名称）。
    用户问题：{user_input}
    """


    def __init__(self, model: str = QUES_OPTIMIZER_MODEL, model_name: str = QUES_OPTIMIZER_MODEL_NAME):
        """
        初始化大语言模型意图分类器
        :param model: 大模型
        :param model_name: 模型名称
        """
        adapter = LLMsAdapter(model=model, model_name=model_name)
        # llm = adapter.get_model_instance()
        llm = adapter.get_chat_model_instance(history=[])
        # 封装指令信息
        prompt = PromptTemplate(
            template=self.QUES_OPTIMITER_PROMPT,
            input_variables=["user_input"]
        )
        parser = StrOutputParser()
        self.chain = prompt | llm | parser

    def optimize_question(self, user_input):
        try:
            model_response = self.chain.invoke(user_input)
            return model_response if model_response else user_input
        except Exception as e:
            print(f"大模型调用错误: {e}")
            return user_input


# 使用示例
if __name__ == "__main__":
    # model_name = QUES_OPTIMIZER_MODEL_NAME
    # model_name = "qwen3-0.6b"
    # model_name = "qwen3-32b"
    # model_name = "qwen3-30b-a3b"
    # model_name = "qwen3-14b"
    # model_name = "qwen3-8b"
    # model_name = "qwen3-4b"
    # model_name = "qwen3-1.7b"
    # model_names = ["qwen3-32b", "qwen3-30b-a3b", "qwen3-14b", "qwen3-8b", "qwen3-4b", "qwen3-1.7b"]
    # model_names = ["qwen3-32b"]
    model_names = ["qwen3-30b-a3b"]
    # model_names = ["qwen3-1.7b"]

    # questions = [
    #     "如何理解神经突触可塑性在记忆形成中的分子机制？",
    #     "肿瘤免疫治疗中CAR-T细胞疗法对实体瘤治疗面临哪些技术瓶颈？",
    #     "间充质干细胞在组织修复中的归巢机制是什么？",
    #     "怎样鉴别诊断大叶性肺炎和支原体肺炎的影像学特征？",
    #     "简述急性心肌梗死患者再灌注治疗的时间窗及治疗方案选择依据？",
    #     "肝药酶CYP450家族各亚型在药物代谢中的主要作用及相互影响？",
    #     "简述肾小球滤过膜的结构特点及其在维持机体水盐平衡中的作用？",
    #     "如何通过病理切片区分高分化与低分化鳞状细胞癌？",
    #     "简述糖尿病肾病的分期标准及各期对应的治疗原则？",
    #     "简述呼吸机相关性肺炎的常见病原菌及预防措施？",
    #     "动脉粥样硬化斑块的不稳定因素有哪些？",
    #     "简述甲状腺功能亢进症的三种主要治疗方法及其优缺点？",
    #     "如何根据血气分析判断呼吸衰竭的类型及治疗策略？",
    #     "简述抗生素联合应用的基本原则和注意事项？",
    #     "简述腰椎间盘突出症的分型及各型的临床表现特点？",
    #     "简述室性心律失常的心电图特征及常用药物治疗？",
    #     "简述新生儿黄疸的分类、发病机制及治疗方法？",
    #     "如何评估脑卒中患者的吞咽功能及制定康复训练方案？",
    #     "简述自身免疫性疾病的发病机制及常见自身抗体检测意义？",
    #     "简述慢性阻塞性肺疾病（COPD）稳定期与急性加重期的治疗差异？",
    #     "学习压力大时，有哪些科学有效的放松方法？",
    #     "如何合理安排时间，平衡医学学习与社交生活？",
    #     "医学类书籍阅读时，怎样提高信息提取和记忆效率？",
    #     "长期久坐学习，如何预防颈椎和腰椎疾病？",
    #     "备考医学考试，怎样制定科学的复习计划？",
    #     "如何克服在医学实践操作中产生的紧张情绪？",
    #     "医学文献阅读过程中，遇到专业术语难以理解怎么办？",
    #     "怎样培养自己在医学学习中的批判性思维？",
    #     "医学实验失败后，如何分析原因并改进？",
    #     "面对医学领域不断更新的知识，如何保持学习动力？",
    #     "简述基因编辑技术（如CRISPR-Cas9）在医学研究中的应用前景和伦理争议？",
    #     "如何理解表观遗传学在疾病发生发展中的调控作用？",
    #     "简述干细胞治疗在神经系统疾病中的临床研究进展？",
    #     "肿瘤标志物在癌症早期诊断中的应用价值及局限性是什么？",
    #     "简述心脏电生理机制及常见心律失常的发生原理？",
    #     "如何运用循证医学方法评估临床诊疗方案的有效性？",
    #     "简述纳米材料在药物递送系统中的应用及面临的挑战？",
    #     "简述阿尔茨海默病的发病机制及当前治疗研究热点？",
    #     "如何进行临床药物试验的设计与实施，确保试验的科学性和可靠性？",
    #     "简述分子靶向治疗在恶性肿瘤治疗中的作用机制及优势？",
    #     "长期熬夜对身体有哪些具体危害，如何调理恢复？",
    #     "怎样判断自己是否处于亚健康状态，该如何改善？",
    #     "减肥期间，怎样搭配饮食既能保证营养又能有效减脂？",
    #     "经常感觉疲劳，可能是哪些健康问题导致的？",
    #     "如何预防和缓解过敏性鼻炎症状？",
    #     "高血压患者在日常生活中有哪些饮食和运动禁忌？",
    #     "女性经期不规律，可能受哪些因素影响，如何调理？",
    #     "长期吸烟对肺部的损伤可以恢复吗，有哪些方法？",
    #     "儿童挑食、偏食，家长应该如何引导改善营养状况？",
    #     "糖尿病患者在血糖控制良好的情况下，能否适量食用水果？",
    #     "经常出现口腔溃疡，是什么原因引起的，怎样治疗？",
    #     "老年人骨质疏松，除了补钙还需要注意什么？",
    #     "如何预防夏季中暑，中暑后该如何急救处理？",
    #     "经常感觉眼睛干涩、疲劳，有哪些护眼方法？",
    #     "睡眠质量差，多梦易醒，有什么改善睡眠的好方法？",
    #     "运动后肌肉酸痛，应该如何快速缓解？",
    #     "经常消化不良，腹胀腹痛，可能是什么原因，如何治疗？",
    #     "如何预防和治疗冻疮？",
    #     "过敏体质人群在日常生活中需要注意哪些方面？",
    #     "长期便秘，有哪些安全有效的改善方法？",
    #     "医学解剖学课程中，如何高效记忆人体各部位结构？",
    #     "学习医学英语有哪些实用的方法和技巧？",
    #     "怎样学好医学统计学，掌握数据分析方法？",
    #     "医学临床课程与理论课程如何更好地结合学习？",
    #     "备考执业医师资格考试，有哪些重点和复习技巧？",
    #     "医学专业的线上学习资源有哪些值得推荐？",
    #     "参加医学学术会议对学习和职业发展有哪些帮助？",
    #     "如何撰写高质量的医学课程论文？",
    #     "医学专业小组讨论学习时，怎样提高参与度和学习效果？",
    #     "学习医学病理学，如何理解疾病的发生发展过程？",
    #     "医学实验课中，如何规范操作提高实验成功率？",
    #     "怎样制定医学专业的长期学习目标和短期计划？",
    #     "医学文献综述该如何撰写，有哪些要点？",
    #     "学习医学微生物学，如何区分各种细菌和病毒的特性？",
    #     "参加医学技能竞赛对个人能力提升有哪些作用？",
    #     "医学专业的跨学科知识学习有什么重要性，该如何开展？",
    #     "如何利用思维导图辅助医学知识的学习和整理？",
    #     "医学学习中遇到难以理解的知识点，如何寻求帮助？",
    #     "怎样评估自己在医学学习中的进步和不足？",
    #     "医学专业的实习阶段，如何快速适应临床工作环境？",
    #     "医学专业有哪些热门的研究方向和就业前景较好的领域？",
    #     "想从事医学科研工作，本科毕业后该如何规划深造路径？",
    #     "国内哪些医学院校在临床医学专业方面实力较强？",
    #     "医学专业学生在校期间，有哪些含金量高的证书可以考取？",
    #     "进入三甲医院工作，需要具备哪些条件和技能？",
    #     "医学专业的国际交流项目有哪些，如何申请？",
    #     "从事医学翻译工作，需要具备哪些专业知识和能力？",
    #     "医学领域创业有哪些可行的方向和注意事项？",
    #     "想转行到医疗相关行业，有哪些选择和转行建议？",
    #     "医学专业的研究生导师该如何选择，有哪些参考因素？",
    #     "参加医学类实习，如何与带教老师和患者建立良好关系？",
    #     "医学学术论文投稿，有哪些合适的期刊和投稿流程？",
    #     "如何准备医学专业的面试，有哪些常见问题和应答技巧？",
    #     "医学继续教育对职业发展有多大帮助，该如何选择学习内容？",
    #     "医学专业学生参加志愿服务活动，对未来发展有什么益处？",
    #     "医疗行业的薪资待遇水平如何，受哪些因素影响？",
    #     "想从事医学教育工作，需要具备哪些条件和能力？",
    #     "医学领域的专利申请流程是怎样的，需要注意什么？",
    #     "如何建立和维护自己在医学领域的专业人脉资源？",
    #     "医学专业毕业后，有哪些途径可以提升自己的综合竞争力？"
    # ]

    questions = [
        # "一直觉得不太对劲",
        # "心里难受",
        # "胃有点问题",
        # "血常规能看出什么？",
        # "怎么看CT",
        # "睡不着、吃不下",
        # "这是不是要紧？",
        # "最近焦虑很厉害",
        # "医生说有点高，什么意思？",
        # "请对比止痛药和消炎药的区别 杂",
        # "用一句话解释肺炎",
        # "拉肚子了，是不是肠胃炎？",
        # "可以用点药吗？",
        # "怎么看“上火”",
        # "孩子最近总咳嗽",
        # "怎么预防癌症？",
        # "血压低，有影响吗？",
        # "报告单能不能看出来啥",
        # "背一直疼，像拉伤",
        # "吃感冒药没好怎么办",
        # "什么是阳性",
        # "医学要怎么学？",
        # "术后多久能恢复？",
        # "补铁的药有哪些？",
        # "检查报告怎么看？",
        # "麻醉会不会有后遗症？",
        # "打完疫苗头晕",
        # "用100字讲讲“靶向治疗”",
        # "请分点说一下胸闷的可能情况",
        # "腰不好",
        # "靶向治疗",
        # "焦虑很厉害"
        "披裂是什么",
        "简述进行动脉穿刺前需要做的准备工作及注意事项。",
        "举例说明在临床护理中必须严格执行无菌操作的三种常见情境，并说明原因。",
        "分析血气分析中出现代谢性酸中毒时，可能伴随的代偿机制有哪些？",
        "比较良性溃疡与胃癌在内镜下的主要区别，有哪几点最关键？",
        "请解释“Babinski征阳性”的临床意义"
        # "急诊中接诊一位交通事故外伤病人，你发现其血压下降、心率加快、皮肤湿冷。判断他是否可能出现失血性休克？请分析依据。",
        # "贫血分哪几类？能简单讲下核心机制吗？",
        # "X光片上肺门增宽，考虑哪几种疾病可能？怎么鉴别？",
        # "抽血时发现血液回抽困难，应该怎么处理？有操作顺序吗？"
    ]

    for model_name in model_names:
        optimizer = MedicalQuestionOptimizer(model="DashScope", model_name=model_name)
        print("-------------------" + model_name + "--------------------")

        for question in questions:
            # print("原问题：" + question + "   优化后问题：" + optimizer.optimize_question(question))
            print("优化后结果：" + optimizer.optimize_question(question))
            print("\n")

